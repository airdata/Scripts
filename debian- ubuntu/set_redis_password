#!/bin/bash

# Configure Redis to use password authentication. If redisPassword is not set,
# an autogenerated 256-bit password will be returned by the script.

# Tested on:
# Debian 7.0
# Ubuntu 12.04
# Ubuntu 14.04

# Usage:
# overcast run myInstanceOrCluster set_redis_password
# overcast run myInstanceOrCluster set_redis_password --env "redisPassword=myPredefinedPassword"

# set -x

if [ "$(id -u)" != "0" ]; then
  echo "This script must be run as root." 1>&2
  exit 1
fi

if [ -z "$redisPassword" ]; then
  redisPassword=`cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w 43 | head -n 1`
  echo "Using autogenerated password:"
  echo "$redisPassword"
fi

sed -i "s/#\? \?requirepass .*/requirepass $redisPassword/g" /etc/redis/redis.conf

# Allow remote connections to Redis:
sed -i "s/#\? \?bind 127.0.0.1/bind 0.0.0.0/g" /etc/redis/redis.conf

service redis-server restart

exit 0
