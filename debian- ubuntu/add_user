#!/bin/bash

# Add new user account.

# Tested on:
# Debian 7.0
# Ubuntu 12.04
# Ubuntu 14.04

# Usage:
# overcast run myInstanceOrCluster add_user --env "username=newuser"

# set -x

usage="Usage: overcast run myInstanceOrCluster add_user --env \"username=newuser\""

if [ "$(id -u)" != "0" ]; then
  echo "This script must be run as root." 1>&2
  echo $usage
  exit 1
fi

if [ -z "$username" ]; then
  echo "No username defined." 1>&2
  echo $usage
  exit 1
fi

if id -u "$username" >/dev/null 2>&1; then
  echo "User $username already exists!" 1>&2
  exit 1
fi

if [ -z "$password" ]; then
  password=`cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w 32 | head -n 1`
  echo "Using autogenerated password:"
  echo "$password"
fi

# Add user.

encrypted_password=$(perl -e "print crypt(\"$password\", \"$username\")")
useradd -m -s /bin/bash -p "$encrypted_password" "$username"

# Set up SSH access.

mkdir -p /home/$username/.ssh
cp /root/.ssh/authorized_keys /home/$username/.ssh/authorized_keys
chown -R $username:$username /home/$username/.ssh
chmod 700 /home/$username/.ssh
chmod 600 /home/$username/.ssh/authorized_keys

echo "User $username created. Home directory is /home/$username."

exit 0
